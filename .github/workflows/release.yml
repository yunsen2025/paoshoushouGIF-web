name: è‡ªåŠ¨æ‰“åŒ…è¡¨æƒ…åŒ…

on:
  push:
    branches: [ main ]
    paths: 
      - 'gif/**'  # åªæœ‰gifæ–‡ä»¶å¤¹å˜åŒ–æ—¶æ‰è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: èŽ·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
    - name: ç»Ÿè®¡è¡¨æƒ…åŒ…æ•°é‡
      id: count
      run: |
        count=$(find gif -name "*.gif" | wc -l)
        echo "count=$count" >> $GITHUB_OUTPUT
        echo "å‘çŽ° $count ä¸ªè¡¨æƒ…åŒ…æ–‡ä»¶"
        
    - name: åˆ›å»ºè¡¨æƒ…åŒ…åŽ‹ç¼©åŒ…
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p release-temp/paoshoushou-gif-pack
        
        # å¤åˆ¶gifæ–‡ä»¶
        cp -r gif/* release-temp/paoshoushou-gif-pack/
        
        # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
        cat > release-temp/paoshoushou-gif-pack/README.txt << EOF
        åˆ¨æ‰‹æ‰‹è¡¨æƒ…åŒ…åˆé›†
        ==================
        
        ðŸ“¦ åŒ…å«è¡¨æƒ…åŒ…æ•°é‡: ${{ steps.count.outputs.count }} ä¸ª
        ðŸ“… æ‰“åŒ…æ—¶é—´: $(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
        ðŸŒ é¡¹ç›®åœ°å€: https://github.com/yunsen2025/paoshoushouGIF-web
        ðŸŽ¯ åœ¨çº¿é¢„è§ˆ: https://paoshoushou.112601.xyz/
        
        ä½¿ç”¨è¯´æ˜Ž:
        - æ‰€æœ‰æ–‡ä»¶å‡ä¸ºGIFæ ¼å¼
        - å¯ç›´æŽ¥ç”¨äºŽQQã€å¾®ä¿¡ç­‰èŠå¤©è½¯ä»¶
        - æ”¯æŒæ‹–æ‹½å¯¼å…¥åˆ°å„ç±»è¡¨æƒ…åŒ…ç®¡ç†å·¥å…·
        
        ç‰ˆæƒå£°æ˜Ž:
        æœ¬è¡¨æƒ…åŒ…ä»…ä¾›ä¸ªäººå­¦ä¹ äº¤æµä½¿ç”¨ï¼Œç‰ˆæƒå½’åŽŸä½œè€…æ‰€æœ‰ã€‚
        å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚
        EOF
        
        # æ‰“åŒ…
        cd release-temp
        zip -r ../paoshoushou-gif-pack-${{ steps.date.outputs.date }}.zip paoshoushou-gif-pack/
        cd ..
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -lh paoshoushou-gif-pack-*.zip
        
    - name: åˆ›å»ºRelease
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: gif-pack-${{ steps.date.outputs.date }}
        release_name: ðŸŽ­ è¡¨æƒ…åŒ…åˆé›† v${{ steps.date.outputs.date }}
        body: |
          ## ðŸ“¦ åˆ¨æ‰‹æ‰‹è¡¨æƒ…åŒ…åˆé›†
          
          ### ðŸ“Š æœ¬æ¬¡æ›´æ–°
          - ðŸŽ­ åŒ…å«è¡¨æƒ…åŒ…: **${{ steps.count.outputs.count }}** ä¸ª
          - ðŸ“… æ‰“åŒ…æ—¶é—´: ${{ steps.date.outputs.date }}
          - ðŸ’¾ æ–‡ä»¶å¤§å°: çº¦ $(du -h paoshoushou-gif-pack-*.zip | cut -f1)
          
          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
          ç‚¹å‡»ä¸‹æ–¹ **paoshoushou-gif-pack-xxx.zip** æ–‡ä»¶å³å¯ä¸‹è½½å®Œæ•´è¡¨æƒ…åŒ…åˆé›†ã€‚
          
          ### ðŸŒ åœ¨çº¿é¢„è§ˆ
          è®¿é—® [https://paoshoushou.112601.xyz/](https://paoshoushou.112601.xyz/) åœ¨çº¿é¢„è§ˆå’Œå•ç‹¬ä¸‹è½½è¡¨æƒ…åŒ…ã€‚
          
          ### ðŸ”„ æ›´æ–°å†…å®¹
          æœ¬ç‰ˆæœ¬åŒ…å«äº†æœ€æ–°çš„è¡¨æƒ…åŒ…æ–‡ä»¶ï¼Œå»ºè®®ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ä»¥èŽ·å¾—å®Œæ•´ä½“éªŒã€‚
          
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼ è¡¨æƒ…åŒ…åŽ‹ç¼©åŒ…
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./paoshoushou-gif-pack-${{ steps.date.outputs.date }}.zip
        asset_name: paoshoushou-gif-pack-${{ steps.date.outputs.date }}.zip
        asset_content_type: application/zip
        
    - name: åˆ›å»ºlatestæ ‡ç­¾ (ä¾¿äºŽå›ºå®šä¸‹è½½é“¾æŽ¥)
      run: |
        # åˆ é™¤åŽŸæœ‰çš„latestæ ‡ç­¾
        git tag -d latest || true
        git push origin :refs/tags/latest || true
        
        # åˆ›å»ºæ–°çš„latestæ ‡ç­¾
        git tag latest
        git push origin latest
